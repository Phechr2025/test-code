{% extends "base.html" %}
{% block title %}{{ series['title'] }} - {{ episode['title'] }}{% endblock %}

{% block content %}
<div class="breadcrumb">
  <a href="{{ url_for('index') }}">หน้าหลัก</a> / 
  <a href="{{ url_for('series_detail', series_id=series['id']) }}">{{ series['title'] }}</a> / 
  <span>{{ episode['title'] }}</span>
</div>

<div class="watch-page">
  {% if blocked %}
    <div class="blocked-box" style="background: #7f1d1d; padding: 2rem; border-radius: 0.75rem; text-align: center;">
      <h2>ปิดการให้ดูชั่วคราว</h2>
      <p>เนื้อหานี้ถูกปิดการรับชมชั่วคราวโดยผู้ดูแลระบบ</p>
    </div>
  {% else %}
    <div class="player-wrapper">
      <video 
        id="main-player"
        controls 
        class="video-player"
        preload="metadata" 
        playsinline
        webkit-playsinline
        style="width: 100%; border-radius: 0.5rem; background: #000;"
      >
        {% if episode['file_path'] or episode['source_type'] in ['gdrive', 'upload'] %}
          <source src="{{ url_for('stream_episode', episode_id=episode['id']) }}" type="video/mp4" />
        {% elif episode['video_url'] %}
          <source src="{{ episode['video_url'] }}" type="video/mp4" />
        {% endif %}
        เบราว์เซอร์ของคุณไม่รองรับการเล่นวิดีโอ
      </video>
    </div>
  {% endif %}

  <div class="video-info">
    <h1>
      {% if episode['episode_number'] %}
        ตอนที่ {{ episode['episode_number'] }}: 
      {% endif %}
      {{ episode['title'] }}
    </h1>
    {% if episode['description'] %}
      <p>{{ episode['description'] }}</p>
    {% endif %}
    <div class="meta" style="margin-top: 1rem; color: #9ca3af; font-size: 0.9rem;">
      <strong>เรื่อง:</strong> {{ series['title'] }}<br>
      <strong>เพิ่มเมื่อ:</strong> {{ episode['created_at']|thdt }}
    </div>
  </div>
</div>

<script>
  // ช่วยแก้ปัญหา iPhone บางเครื่องโหลดช้า โดยการเช็คการโหลด metadata
  const v = document.getElementById('main-player');
  if (v) {
    v.addEventListener('error', function() {
      console.log('Video error or interrupted');
    }, true);
  }
</script>
{% endblock %}
