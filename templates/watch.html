{% extends "base.html" %}
{% block title %}{{ series['title'] }} - {{ episode['title'] }}<script>
document.addEventListener("DOMContentLoaded", function () {
  const container = document.getElementById("player-container");
  const video = container ? container.querySelector("video") : null;
  const miniOverlay = document.getElementById("mini-overlay");
  const enterMiniBtn = document.getElementById("enter-mini");
  const closeBtn = document.getElementById("mini-close");
  const togglePlayBtn = document.getElementById("mini-toggle-play");
  const seekInput = document.getElementById("mini-seek");

  if (!container || !video) return;

  let isMini = false;
  let sizeIndex = 2; // 0 = small, 1 = medium, 2 = large
  let lastTap = 0;
  const sizeClasses = ["mini-size-small", "mini-size-medium", "mini-size-large"];

  function applySize() {
    sizeClasses.forEach(c => container.classList.remove(c));
    container.classList.add(sizeClasses[sizeIndex]);
  }

  function enterMini() {
    if (isMini) return;
    isMini = true;
    container.classList.add("mini-player");
    applySize();
    miniOverlay.classList.remove("hidden");
  }

  function exitMini() {
    isMini = false;
    container.classList.remove("mini-player");
    sizeClasses.forEach(c => container.classList.remove(c));
    miniOverlay.classList.add("hidden");
  }

  if (enterMiniBtn) {
    enterMiniBtn.addEventListener("click", function (e) {
      e.stopPropagation();
      enterMini();
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener("click", function (e) {
      e.stopPropagation();
      exitMini();
    });
  }

  if (togglePlayBtn) {
    togglePlayBtn.addEventListener("click", function (e) {
      e.stopPropagation();
      if (video.paused) {
        video.play();
        togglePlayBtn.textContent = "หยุด";
      } else {
        video.pause();
        togglePlayBtn.textContent = "เล่นต่อ";
      }
    });
  }

  if (video) {
    video.addEventListener("timeupdate", function () {
      if (!seekInput || !video.duration || isNaN(video.duration)) return;
      seekInput.value = (video.currentTime / video.duration) * 100;
    });
  }

  if (seekInput) {
    seekInput.addEventListener("input", function (e) {
      e.stopPropagation();
      if (!video || !video.duration || isNaN(video.duration)) return;
      const pct = parseFloat(seekInput.value) || 0;
      video.currentTime = (pct / 100) * video.duration;
    });
  }

  if (container) {
    container.addEventListener("click", function (e) {
      if (!isMini) return;
      const now = Date.now();
      const delta = now - lastTap;

      if (delta > 0 && delta < 300) {
        // double tap -> change size
        sizeIndex = (sizeIndex + 1) % sizeClasses.length;
        applySize();
      } else {
        // single tap -> toggle overlay visibility
        miniOverlay.classList.toggle("hidden");
      }
      lastTap = now;
    });
  }
});
</script>

{% endblock %}

{% block content %}
<div class="breadcrumb">
  <a href="{{ url_for('index') }}">หน้าหลัก</a> /
  <a href="{{ url_for('series_detail', series_id=series['id']) }}">{{ series['title'] }}</a> /
  <span>{{ episode['title'] }}</span>
</div>

<div class="watch-page">
  {% if blocked %}
    <div class="blocked-box">
      <h2>ปิดการให้ดูชั่วคราว</h2>
      <p>เนื้อหานี้ถูกปิดการรับชมชั่วคราวโดยผู้ดูแลระบบ</p>
    </div>
  {% else %}
    <div id="player-container" class="player-wrapper player-size-large">
      <video
      controls
      class="video-player"
      controlslist="nodownload noplaybackrate"
      disablepictureinpicture
      oncontextmenu="return false;"
    >
      {% if episode['file_path'] %}
        <source src="{{ url_for('stream_episode', episode_id=episode['id']) }}" type="video/mp4" />
      {% elif episode['video_url'] %}
        <source src="{{ episode['video_url'] }}" type="video/mp4" />
      {% endif %}
      เบราว์เซอร์ของคุณไม่รองรับการเล่นวิดีโอ
    </video>

<div id="mini-overlay" class="mini-overlay hidden">
  <button id="mini-close" class="mini-btn mini-close-btn">✕</button>
  <div class="mini-middle-controls">
    <button id="mini-toggle-play" class="mini-btn">หยุด / เล่น</button>
  </div>
  <div class="mini-bottom-bar">
    <input id="mini-seek" type="range" min="0" max="100" value="0">
  </div>
</div>
  </div>
  <button id="enter-mini" class="mini-toggle-btn">ย่อหน้าจอ</button>
  {% endif %}

  <div class="video-info">
    <h1>
      {% if episode['episode_number'] %}
        ตอนที่ {{ episode['episode_number'] }}:
      {% endif %}
      {{ episode['title'] }}
    </h1>
    {% if episode['description'] %}
      <p>{{ episode['description'] }}</p>
    {% endif %}
    <p class="meta">
      เรื่อง: {{ series['title'] }}<br>
      เพิ่มเมื่อ: {{ episode['created_at'] }}
    </p>
    
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const container = document.getElementById("player-container");
  const video = container ? container.querySelector("video") : null;
  const miniOverlay = document.getElementById("mini-overlay");
  const enterMiniBtn = document.getElementById("enter-mini");
  const closeBtn = document.getElementById("mini-close");
  const togglePlayBtn = document.getElementById("mini-toggle-play");
  const seekInput = document.getElementById("mini-seek");

  if (!container || !video) return;

  let isMini = false;
  let sizeIndex = 2; // 0 = small, 1 = medium, 2 = large
  let lastTap = 0;
  const sizeClasses = ["mini-size-small", "mini-size-medium", "mini-size-large"];

  function applySize() {
    sizeClasses.forEach(c => container.classList.remove(c));
    container.classList.add(sizeClasses[sizeIndex]);
  }

  function enterMini() {
    if (isMini) return;
    isMini = true;
    container.classList.add("mini-player");
    applySize();
    miniOverlay.classList.remove("hidden");
  }

  function exitMini() {
    isMini = false;
    container.classList.remove("mini-player");
    sizeClasses.forEach(c => container.classList.remove(c));
    miniOverlay.classList.add("hidden");
  }

  if (enterMiniBtn) {
    enterMiniBtn.addEventListener("click", function (e) {
      e.stopPropagation();
      enterMini();
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener("click", function (e) {
      e.stopPropagation();
      exitMini();
    });
  }

  if (togglePlayBtn) {
    togglePlayBtn.addEventListener("click", function (e) {
      e.stopPropagation();
      if (video.paused) {
        video.play();
        togglePlayBtn.textContent = "หยุด";
      } else {
        video.pause();
        togglePlayBtn.textContent = "เล่นต่อ";
      }
    });
  }

  if (video) {
    video.addEventListener("timeupdate", function () {
      if (!seekInput || !video.duration || isNaN(video.duration)) return;
      seekInput.value = (video.currentTime / video.duration) * 100;
    });
  }

  if (seekInput) {
    seekInput.addEventListener("input", function (e) {
      e.stopPropagation();
      if (!video || !video.duration || isNaN(video.duration)) return;
      const pct = parseFloat(seekInput.value) || 0;
      video.currentTime = (pct / 100) * video.duration;
    });
  }

  if (container) {
    container.addEventListener("click", function (e) {
      if (!isMini) return;
      const now = Date.now();
      const delta = now - lastTap;

      if (delta > 0 && delta < 300) {
        // double tap -> change size
        sizeIndex = (sizeIndex + 1) % sizeClasses.length;
        applySize();
      } else {
        // single tap -> toggle overlay visibility
        miniOverlay.classList.toggle("hidden");
      }
      lastTap = now;
    });
  }
});
</script>

{% endblock %}
