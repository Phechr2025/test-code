{% extends "base.html" %}
{% block title %}แก้ไขตอน - {{ series['title'] }}{% endblock %}

{% block content %}
<div class="breadcrumb">
  <a href="{{ url_for('admin_series') }}">จัดการเรื่อง</a> /
  <a href="{{ url_for('admin_episodes', series_id=series['id']) }}">ตอนของ {{ series['title'] }}</a> /
  <span>แก้ไขตอน</span>
</div>

<h1>แก้ไขตอนของเรื่อง: {{ series['title'] }}</h1>

<form method="post" class="form" enctype="multipart/form-data">
  <label for="episode_number">เลขตอน (เช่น 1, 2, 3) (ไม่บังคับ)</label>
  <input
    type="number"
    id="episode_number"
    name="episode_number"
    min="1"
    value="{{ episode['episode_number'] or '' }}"
  />

  <label for="title">ชื่อตอน *</label>
  <input
    type="text"
    id="title"
    name="title"
    value="{{ episode['title'] }}"
    required
  />

  <label for="description">คำอธิบายตอน (ไม่บังคับ)</label>
  <textarea id="description" name="description" rows="3">{{ episode['description'] or '' }}</textarea>

  <div class="episode-thumb-wrapper" style="margin-top:0.75rem;">
    {% if episode['thumbnail_url'] %}
      {% set ethumb = episode['thumbnail_url'] %}
      {% if ethumb.startswith('http') %}
        <img src="{{ ethumb }}" alt="{{ episode['title'] }}" class="episode-thumb" />
      {% else %}
        <img src="{{ url_for('static', filename=ethumb) }}" alt="{{ episode['title'] }}" class="episode-thumb" />
      {% endif %}
      <div class="hint">ปกตอนปัจจุบัน (หากอัปโหลดใหม่ ระบบจะใช้รูปใหม่แทน)</div>
    {% else %}
      <div class="episode-thumb placeholder-small">ยังไม่มีปกตอน</div>
    {% endif %}
  </div>

  <label for="thumbnail_url">เปลี่ยนเป็นลิงก์รูปปกตอน (ถ้ามีจากเน็ต)</label>
  <input type="url" id="thumbnail_url" name="thumbnail_url" />

  <label for="cover_file">หรืออัปโหลดรูปปกตอนใหม่จากมือถือ</label>
  <input type="file" id="cover_file" name="cover_file" accept="image/*" />

  <hr class="divider" />

  <p class="form-section-title">แหล่งที่มาของวิดีโอ</p>

  <p class="hint">
    แหล่งวิดีโอปัจจุบัน:
    {% if episode['source_type'] == 'direct' %}
      ลิงก์ตรง (direct URL)
    {% elif episode['source_type'] == 'gdrive' %}
      Google Drive (ดาวน์โหลดมาเก็บไว้แล้ว)
    {% elif episode['source_type'] == 'upload' %}
      ไฟล์ที่อัปโหลดไว้บนเซิร์ฟเวอร์
    {% else %}
      ไม่ทราบประเภท
    {% endif %}
  </p>

  <div class="mode-selector">
    <label>
      <input type="radio" name="mode" value="keep" checked />
      ไม่เปลี่ยนวิดีโอ (แก้เฉพาะข้อมูล/ปก)
    </label>
    <label>
      <input type="radio" name="mode" value="direct" />
      เปลี่ยนเป็นลิงก์ mp4 โดยตรง
    </label>
    <label>
      <input type="radio" name="mode" value="gdrive" />
      เปลี่ยนเป็น Google Drive (ใช้ gdown)
    </label>
    <label>
      <input type="radio" name="mode" value="upload" />
      เปลี่ยนเป็นไฟล์ mp4 ที่อัปโหลดจากเครื่อง
    </label>
  </div>

  <div class="mode-block" id="mode-direct" style="display:none;">
    <label for="video_url">ลิงก์วิดีโอ (ไฟล์ .mp4 หรือ URL ที่เล่นได้) *</label>
    <input type="url" id="video_url" name="video_url" />
  </div>

  <div class="mode-block" id="mode-gdrive" style="display:none;">
    <label for="drive_link">ลิงก์หรือไฟล์ไอดีของ Google Drive *</label>
    <input type="text" id="drive_link" name="drive_link" />
    <p class="hint">
      ตัวอย่างลิงก์: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
      หรือกรอกเฉพาะ FILE_ID ก็ได้
    </p>
  </div>

  <div class="mode-block" id="mode-upload" style="display:none;">
    <label for="file">เลือกไฟล์วิดีโอ (.mp4) *</label>
    <input type="file" id="file" name="file" accept="video/mp4" />
  </div>

  <button type="submit" class="btn primary">บันทึกการแก้ไขตอน</button>
  <a href="{{ url_for('admin_episodes', series_id=series['id']) }}" class="btn back-btn">ย้อนกลับ</a>
</form>

<script>
  const radios = document.querySelectorAll('input[name="mode"]');
  const blockDirect = document.getElementById("mode-direct");
  const blockGdrive = document.getElementById("mode-gdrive");
  const blockUpload = document.getElementById("mode-upload");

  function updateMode() {
    const value = document.querySelector('input[name="mode"]:checked').value;
    blockDirect.style.display = value === "direct" ? "block" : "none";
    blockGdrive.style.display = value === "gdrive" ? "block" : "none";
    blockUpload.style.display = value === "upload" ? "block" : "none";
  }

  radios.forEach(r => r.addEventListener("change", updateMode));
  updateMode();
</script>
{% endblock %}
