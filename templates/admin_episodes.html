
{% extends "base.html" %}
{% block title %}จัดการตอน - {{ series['title'] }}{% endblock %}

{% block content %}
<div class="breadcrumb">
  <a href="{{ url_for('admin_series') }}">จัดการเรื่อง</a> /
  <span>{{ series['title'] }}</span>
</div>

<h1>จัดการตอนของเรื่อง: {{ series['title'] }}</h1>

<h2>เพิ่มตอนใหม่</h2>
<form method="post" class="form" enctype="multipart/form-data">
  <label for="episode_number">เลขตอน (เช่น 1, 2, 3) (ไม่บังคับ)</label>
  <input type="number" id="episode_number" name="episode_number" min="1" />

  <label for="title">ชื่อตอน *</label>
  <input type="text" id="title" name="title" required />

  <label for="description">คำอธิบายตอน</label>
  <textarea id="description" name="description" rows="3"></textarea>

  <label for="thumbnail_url">ลิงก์รูปปกตอน (ถ้ามีจากเน็ต)</label>
  <input type="url" id="thumbnail_url" name="thumbnail_url" />

  <label for="cover_file">หรืออัปโหลดรูปปกตอนจากมือถือ</label>
  <input type="file" id="cover_file" name="cover_file" accept="image/*" />

  <hr class="divider" />

  <p class="form-section-title">เลือกโหมดแหล่งที่มาของวิดีโอ</p>

  <div class="mode-selector">
    <label>
      <input type="radio" name="mode" value="direct" checked />
      โหมด A: ลิงก์ mp4 โดยตรง
    </label>
    <label>
      <input type="radio" name="mode" value="gdrive" />
      โหมด B: Google Drive (ใช้ gdown)
    </label>
    <label>
      <input type="radio" name="mode" value="upload" />
      โหมด C: อัปโหลดไฟล์ mp4 จากเครื่อง
    </label>
  </div>

  <div class="mode-block" id="mode-direct">
    <label for="video_url">ลิงก์วิดีโอ (ไฟล์ .mp4 หรือ URL ที่เล่นได้) *</label>
    <input type="url" id="video_url" name="video_url" />
  </div>

  <div class="mode-block" id="mode-gdrive" style="display:none;">
    <label for="drive_link">ลิงก์หรือไฟล์ไอดีของ Google Drive *</label>
    <input type="text" id="drive_link" name="drive_link" />
    <p class="hint">
      ตัวอย่างลิงก์: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
      หรือกรอกเฉพาะ FILE_ID ก็ได้
    </p>
  </div>

  <div class="mode-block" id="mode-upload" style="display:none;">
    <label for="file">เลือกไฟล์วิดีโอ (.mp4) *</label>
    <input type="file" id="file" name="file" accept="video/mp4" />
  </div>

  <button type="submit" class="btn primary">บันทึกตอนใหม่</button>
</form>

<h2 style="margin-top:2rem;">รายการตอนในเรื่องนี้</h2>

{% if episodes %}
  <ul class="episode-list-admin">
    {% for ep in episodes %}
      <li class="episode-item-admin">
        <div class="episode-thumb-wrapper">
          {% if ep['thumbnail_url'] %}
            {% set ethumb = ep['thumbnail_url'] %}
            {% if ethumb.startswith('http') %}
              <img src="{{ ethumb }}" alt="{{ ep['title'] }}" class="episode-thumb" />
            {% else %}
              <img src="{{ url_for('static', filename=ethumb) }}" alt="{{ ep['title'] }}" class="episode-thumb" />
            {% endif %}
          {% else %}
            <div class="episode-thumb placeholder-small">ไม่มีปกตอน</div>
          {% endif %}
        </div>
        <div class="episode-main">
          <div class="episode-title-line">
            <strong>ตอน {{ ep['episode_number'] or '-' }} - {{ ep['title'] }}</strong>
            {% if ep.get('is_active', 1) %}
              <span style="color:#0c0; margin-left:8px;">(เปิด)</span>
            {% else %}
              <span style="color:#c00; margin-left:8px;">(ปิดชั่วคราว)</span>
            {% endif %}
          </div>
          {% if ep['description'] %}
            <div class="episode-desc">
              {{ ep['description'][:100] }}{% if ep['description']|length > 100 %}...{% endif %}
            </div>
          {% endif %}
        </div>
        <div class="episode-actions">
          <!-- ปุ่มเปิด/ปิดทันที -->
          <form method="post" action="{{ url_for('admin_toggle_episode', episode_id=ep['id']) }}" style="display:inline;">
            <button type="submit" class="btn">
              {% if ep.get('is_active', 1) %}ปิดการดู{% else %}เปิดการดู{% endif %}
            </button>
          </form>

          <!-- ตั้งเวลาแบบ HH:MM -->
          <form method="post" action="{{ url_for('admin_episode_schedule_time', episode_id=ep['id']) }}" style="display:inline;">
            <input type="time" name="time" required />
            <select name="action">
              <option value="close">ปิด</option>
              <option value="open">เปิด</option>
            </select>
            <button type="submit" class="btn">ตั้งเวลา</button>
          </form>

          <!-- ตั้งนับถอยหลัง (นาที) -->
          <form method="post" action="{{ url_for('admin_episode_schedule_countdown', episode_id=ep['id']) }}" style="display:inline;">
            <input type="number" name="minutes" min="1" placeholder="นาที" required />
            <select name="action">
              <option value="close">ปิด</option>
              <option value="open">เปิด</option>
            </select>
            <button type="submit" class="btn">นับถอยหลัง</button>
          </form>

          <!-- ยกเลิกการตั้งเวลา -->
          <form method="post" action="{{ url_for('admin_episode_cancel_schedule', episode_id=ep['id']) }}" style="display:inline;">
            <button type="submit" class="btn danger">ยกเลิกการตั้งเวลา</button>
          </form>

          <!-- ปุ่มเดิม -->
          <a class="btn" href="{{ url_for('watch_episode', series_id=series['id'], episode_id=ep['id']) }}" target="_blank">ดูตอน</a>
          <a class="btn" href="{{ url_for('admin_edit_episode', episode_id=ep['id']) }}">แก้ไขตอน</a>
          <form method="post" action="{{ url_for('admin_delete_episode', episode_id=ep['id']) }}" onsubmit="return confirm('ยืนยันการลบตอนนี้?');">
            <button type="submit" class="btn danger">ลบตอน</button>
          </form>
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>ยังไม่มีตอนในเรื่องนี้</p>
{% endif %}

<script>
  const radios = document.querySelectorAll('input[name="mode"]');
  const blockDirect = document.getElementById("mode-direct");
  const blockGdrive = document.getElementById("mode-gdrive");
  const blockUpload = document.getElementById("mode-upload");

  function updateMode() {
    const value = document.querySelector('input[name="mode"]:checked').value;
    blockDirect.style.display = value === "direct" ? "block" : "none";
    blockGdrive.style.display = value === "gdrive" ? "block" : "none";
    blockUpload.style.display = value === "upload" ? "block" : "none";
  }

  radios.forEach(r => r.addEventListener("change", updateMode));
  updateMode();
</script>
{% endblock %}
